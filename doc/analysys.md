# Implementation Plan for Windsurf

## Context Analysis

Based on the scripts and implementation gaps document, here's a structured plan to fix the issues while maintaining the **4-script modular architecture** with all data on `/mnt/data`.

---

## Phase 1: Audit Current State

Before writing any code, have Windsurf read and map the current state:

```
READ ALL 5 SCRIPTS AND CREATE:
- Service registry (what script 1 installs)
- URL routing map (what script 2 should expose)
- Configuration dependencies (what script 3 needs)
- Gap matrix between current vs expected
```

---

## Implementation Plan

### ðŸ”§ Script 1 (`1-setup-system.sh`) â€” Fixes Needed

**Issue:** Service definitions incomplete/inconsistent â€” script 2 and 3 can't reliably discover what was installed.

**Fix:**
```bash
# After each service install, write a manifest file
# Windsurf should add at the END of each service install block:

SERVICE_MANIFEST="/mnt/data/config/installed_services.json"

write_service_manifest() {
  local service=$1
  local port=$2
  local path=$3
  local container=$4
  
  # Append to JSON manifest
  jq --arg s "$service" \
     --arg p "$port" \
     --arg path "$path" \
     --arg c "$container" \
     '.services[$s] = {port: $p, path: $path, container: $c, installed: true}' \
     "$SERVICE_MANIFEST" > tmp.json && mv tmp.json "$SERVICE_MANIFEST"
}

# Called after each service docker-compose up:
write_service_manifest "flowise"    "3000" "/flowise"    "flowise"
write_service_manifest "grafana"    "3001" "/grafana"    "grafana"
write_service_manifest "n8n"        "5678" "/n8n"        "n8n"
write_service_manifest "openclaw"   "3002" "/openclaw"   "openclaw"
write_service_manifest "dify"       "80"   "/dify"       "dify-web"
write_service_manifest "anythingllm" "3001" "/anythingllm" "anythingllm"
write_service_manifest "litellm"    "4000" "/litellm"    "litellm"
write_service_manifest "openwebui"  "8080" "/openwebui"  "open-webui"
write_service_manifest "signal"     "8080" "/signal"     "signal-cli-rest-api"
write_service_manifest "minio"      "9001" "/minio"      "minio"
```

**Why:** Scripts 2, 3, and 4 can then READ this manifest instead of hardcoding assumptions.

---

### ðŸŒ Script 2 (`2-deploy-services.sh`) â€” Primary Focus

**Issue:** Nginx/Caddy reverse proxy configuration is incomplete â€” paths not properly routed, sub-path stripping issues, websocket headers missing.

**Windsurf Task: Rebuild the proxy config generation block**

#### Nginx Config Template Per Service:

```nginx
# /mnt/data/config/nginx/conf.d/ai-platform.conf
# Generated by script 2 - DO NOT EDIT MANUALLY

# â”€â”€ FLOWISE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
location /flowise/ {
    proxy_pass         http://flowise:3000/;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection "upgrade";
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
}

# â”€â”€ GRAFANA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
location /grafana/ {
    proxy_pass         http://grafana:3000/;
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
}

# â”€â”€ N8N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
location /n8n/ {
    proxy_pass         http://n8n:5678/;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection "upgrade";
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
}

# â”€â”€ OPENCLAW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
location /openclaw/ {
    proxy_pass         http://openclaw:3002/;
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
}

# â”€â”€ DIFY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
location /dify/ {
    proxy_pass         http://dify-web:80/;
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
}
location /dify/api/ {
    proxy_pass         http://dify-api:5001/;
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
}

# â”€â”€ ANYTHINGLLM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
location /anythingllm/ {
    proxy_pass         http://anythingllm:3001/;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection "upgrade";
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
}

# â”€â”€ LITELLM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
location /litellm/ {
    proxy_pass         http://litellm:4000/;
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
}

# â”€â”€ OPEN WEBUI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
location /openwebui/ {
    proxy_pass         http://open-webui:8080/;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection "upgrade";
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
}

# â”€â”€ SIGNAL API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
location /signal/ {
    proxy_pass         http://signal-cli-rest-api:8080/;
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
}

# â”€â”€ MINIO CONSOLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
location /minio/ {
    proxy_pass         http://minio:9001/;
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
}

# â”€â”€ OLLAMA API (direct port, no path routing) â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Access via: http://server-ip:11434
# Not exposed through nginx by design
```

#### Script 2 Core Function â€” Read Manifest, Generate Config:

```bash
generate_nginx_config() {
  local manifest="/mnt/data/config/installed_services.json"
  local nginx_conf="/mnt/data/config/nginx/conf.d/ai-platform.conf"
  
  # Verify manifest exists
  if [[ ! -f "$manifest" ]]; then
    log "ERROR" "Service manifest not found. Run script 1 first."
    exit 1
  fi
  
  # Generate config only for installed services
  echo "server {" > "$nginx_conf"
  echo "    listen 80;" >> "$nginx_conf"
  echo "    server_name ai.datasquiz.net;" >> "$nginx_conf"
  
  # Read each installed service from manifest and append location block
  jq -r '.services | to_entries[] | select(.value.installed == true) | .key' "$manifest" | \
  while read -r service; do
    generate_location_block "$service" >> "$nginx_conf"
  done
  
  echo "}" >> "$nginx_conf"
}
```

#### Script 2 Validation Block (ADD AT END):

```bash
validate_deployments() {
  log "INFO" "Validating all service endpoints..."
  
  local services=(
    "flowise|/flowise|200"
    "grafana|/grafana|302"  # grafana redirects
    "n8n|/n8n|200"
    "openclaw|/openclaw|200"
    "dify|/dify|200"
    "anythingllm|/anythingllm|200"
    "litellm|/litellm|200"
    "openwebui|/openwebui|200"
    "signal|/signal|200"
    "minio|/minio|200"
  )
  
  local failed=0
  for entry in "${services[@]}"; do
    IFS='|' read -r name path expected_code <<< "$entry"
    
    # Only check if installed
    if jq -e ".services.\"$name\".installed" /mnt/data/config/installed_services.json > /dev/null 2>&1; then
      actual_code=$(curl -s -o /dev/null -w "%{http_code}" \
        --max-time 10 "https://ai.datasquiz.net${path}")
      
      if [[ "$actual_code" == "$expected_code" ]]; then
        log "SUCCESS" "âœ“ $name: https://ai.datasquiz.net${path} (HTTP $actual_code)"
      else
        log "WARN" "âœ— $name: https://ai.datasquiz.net${path} (got $actual_code, expected $expected_code)"
        ((failed++))
      fi
    fi
  done
  
  if [[ $failed -gt 0 ]]; then
    log "WARN" "$failed service(s) not responding correctly"
    log "INFO" "Check: docker ps -a | grep -v Up"
  fi
}

# Call at end of script 2
validate_deployments
```

---

### âš™ï¸ Script 3 (`3-configure-services.sh`) â€” Fixes Needed

**Issue:** Configuration applied before services are healthy, env vars not propagated correctly.

**Windsurf Task:**

```bash
# ADD: Health gate before any configuration
wait_for_service() {
  local service=$1
  local url=$2
  local max_attempts=30
  local attempt=0
  
  log "INFO" "Waiting for $service to be healthy..."
  while [[ $attempt -lt $max_attempts ]]; do
    if curl -sf --max-time 5 "$url" > /dev/null 2>&1; then
      log "SUCCESS" "$service is ready"
      return 0
    fi
    ((attempt++))
    sleep 10
  done
  log "ERROR" "$service failed to become healthy after ${max_attempts} attempts"
  return 1
}

# ADD: Service-aware configuration
configure_only_installed() {
  local manifest="/mnt/data/config/installed_services.json"
  
  # Read manifest and configure only installed services
  if jq -e '.services.grafana.installed' "$manifest" > /dev/null 2>&1; then
    configure_grafana
  fi
  
  if jq -e '.services.n8n.installed' "$manifest" > /dev/null 2>&1; then
    configure_n8n
  fi
  # ... etc
}
```

**Key service-specific fixes for script 3:**

```bash
# GRAFANA: Must set root_url for sub-path
configure_grafana() {
  wait_for_service "grafana" "http://localhost:3000"
  
  # Grafana requires root_url for sub-path to work
  local grafana_ini="/mnt/data/grafana/grafana.ini"
  cat >> "$grafana_ini" << 'EOF'
[server]
root_url = https://ai.datasquiz.net/grafana/
serve_from_sub_path = true
EOF
  docker restart grafana
}

# N8N: Must set WEBHOOK_URL and PATH
configure_n8n() {
  wait_for_service "n8n" "http://localhost:5678"
  
  # n8n needs these ENV vars for sub-path
  # These should already be in docker-compose but verify:
  docker exec n8n env | grep -E "N8N_PATH|WEBHOOK_URL" || \
    log "WARN" "n8n sub-path env vars missing"
}

# MINIO: Set alias for sub-path console
configure_minio() {
  wait_for_service "minio" "http://localhost:9000"
  
  # MinIO console sub-path
  docker exec minio sh -c \
    'echo "MINIO_BROWSER_REDIRECT_URL=https://ai.datasquiz.net/minio" >> /etc/environment'
}
```

---

### âž• Script 4 (`4-add-service.sh`) â€” Fixes Needed

**Issue:** New services added don't automatically get nginx routing or manifest entry.

**Windsurf Task:**

```bash
add_service() {
  local service_name=$1
  local service_port=$2
  local service_path=$3
  local container_name=$4
  local compose_file=$5
  
  # 1. Deploy the service
  docker-compose -f "$compose_file" up -d
  
  # 2. Update manifest
  write_service_manifest "$service_name" "$service_port" "$service_path" "$container_name"
  
  # 3. Regenerate nginx config (call shared function from script 2)
  source /mnt/data/scripts/lib/nginx-generator.sh
  generate_nginx_config
  
  # 4. Reload nginx
  docker exec nginx nginx -t && docker exec nginx nginx -s reload
  
  # 5. Validate new endpoint
  sleep 5
  validate_single_endpoint "$service_name" "$service_path"
  
  log "SUCCESS" "Service $service_name added: https://ai.datasquiz.net${service_path}"
}
```

---

## Phase 2: Shared Library Extraction

**Windsurf Task: Create `/mnt/data/scripts/lib/` directory with shared functions:**

```
/mnt/data/scripts/lib/
â”œâ”€â”€ common.sh          # logging, colors, error handling
â”œâ”€â”€ manifest.sh        # read/write service manifest
â”œâ”€â”€ nginx-generator.sh # generate nginx location blocks
â”œâ”€â”€ health-check.sh    # wait_for_service, validate_endpoints
â””â”€â”€ docker-helpers.sh  # docker-compose wrappers
```

**Each script sources what it needs:**
```bash
# At top of each script:
SCRIPT_DIR="/mnt/data/scripts"
source "${SCRIPT_DIR}/lib/common.sh"
source "${SCRIPT_DIR}/lib/manifest.sh"
source "${SCRIPT_DIR}/lib/health-check.sh"
```

---

## Phase 3: Docker Compose Environment Variables

**Windsurf Task: For each service that needs sub-path support, ensure the docker-compose file sets the right env:**

```yaml
# /mnt/data/n8n/docker-compose.yml
services:
  n8n:
    environment:
      - N8N_PATH=/n8n/
      - WEBHOOK_URL=https://ai.datasquiz.net/n8n/
      - N8N_EDITOR_BASE_URL=https://ai.datasquiz.net/n8n/

# /mnt/data/grafana/docker-compose.yml  
services:
  grafana:
    environment:
      - GF_SERVER_ROOT_URL=https://ai.datasquiz.net/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true

# /mnt/data/flowise/docker-compose.yml
services:
  flowise:
    environment:
      - FLOWISE_BASE_PATH=/flowise

# /mnt/data/anythingllm/docker-compose.yml
services:
  anythingllm:
    environment:
      - STORAGE_DIR=/app/server/storage
      - APP_BASE_PATH=/anythingllm

# /mnt/data/minio/docker-compose.yml
services:
  minio:
    environment:
      - MINIO_BROWSER_REDIRECT_URL=https://ai.datasquiz.net/minio
```

---

## Phase 4: SSL/TLS Handling in Script 2

```bash
# Script 2 should handle cert provisioning BEFORE validation
setup_ssl() {
  local domain="ai.datasquiz.net"
  local cert_path="/mnt/data/certs"
  
  mkdir -p "$cert_path"
  
  # Option A: Certbot standalone (nginx must be stopped)
  if ! [[ -f "$cert_path/fullchain.pem" ]]; then
    docker run --rm -p 80:80 \
      -v "$cert_path:/etc/letsencrypt/live/$domain" \
      certbot/certbot certonly \
      --standalone \
      --non-interactive \
      --agree-tos \
      --email admin@datasquiz.net \
      -d "$domain"
  fi
  
  # Update nginx config to use SSL
  # ... nginx ssl block generation
}
```

---

## Windsurf Prompt â€” Final Implementation Instructions

```
TASK: Fix the AI Platform Automation scripts

CONSTRAINTS:
- 4 scripts only: 1-setup-system.sh, 2-deploy-services.sh, 
  3-configure-services.sh, 4-add-service.sh
- Shared code goes in /mnt/data/scripts/lib/ (sourced, not a 5th script)
- All data stored under /mnt/data/
- Modular: script 2/3/4 must read from manifest created by script 1
- Do NOT change the overall script flow

PRIORITY ORDER:
1. Add service manifest write to script 1 (after each service install)
2. Fix nginx config generation in script 2 (sub-paths, websockets, SSL)
3. Add health-gate + sub-path env vars to script 3
4. Wire manifest + nginx-reload into script 4
5. Add validation block at end of script 2

KEY BUGS TO FIX:
- Nginx location blocks missing trailing slash on proxy_pass
- Missing websocket upgrade headers (n8n, flowise, anythingllm, openwebui)
- Grafana not setting GF_SERVER_ROOT_URL / SERVE_FROM_SUB_PATH
- Script 3 configuring services before they're healthy
- Script 4 not updating nginx after adding new service
- MinIO BROWSER_REDIRECT_URL not set for sub-path

FILES TO CREATE:
- /mnt/data/scripts/lib/common.sh
- /mnt/data/scripts/lib/manifest.sh  
- /mnt/data/scripts/lib/nginx-generator.sh
- /mnt/data/scripts/lib/health-check.sh
- /mnt/data/config/nginx/conf.d/ai-platform.conf (generated)
- /mnt/data/config/installed_services.json (written by script 1)
```

---

## Summary Table

| Script | Key Fix | Priority |
|--------|---------|----------|
| Script 1 | Write service manifest after each install | ðŸ”´ Critical |
| Script 2 | Fix nginx sub-path routing + websockets + SSL | ðŸ”´ Critical |
| Script 2 | Add endpoint validation block | ï¿½ï¿½ High |
| Script 3 | Health-gate before config + sub-path env vars | ðŸ”´ Critical |
| Script 4 | Update manifest + regenerate nginx on add | ðŸŸ¡ High |
| All | Extract shared lib to `/mnt/data/scripts/lib/` | ðŸŸ¢ Medium |
